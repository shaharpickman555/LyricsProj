<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    :root{
      --bg:#f9fafb; --fg:#212529; --muted:#6c757d;
      --card:#fff; --border:#e6e9ee;
      --accent:#ff6b35; --accent-hover:#e05b2e; --ring:rgba(255,107,53,.22);
      --shadow:0 6px 24px rgba(17,24,39,.08);
    }
    body{background:var(--bg); color:var(--fg); padding:16px; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;}
    .container{max-width:1100px;}
    h1{font-weight:800; letter-spacing:.2px; margin:.25rem 0 .75rem}
    .toolbar{display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin:.75rem 0 1rem}
    .badge-mode{font-size:.75rem; border:1px solid var(--border); background:#fff; color:#444; border-radius:.5rem; padding:.15rem .5rem}
    .table thead th{border-bottom:1px solid var(--border);}
    .table tbody td{vertical-align:middle;}
    .status-dot{display:inline-block; width:.6rem; height:.6rem; border-radius:50%;}
    .status-dot.proc{background: #ff6b35;}
    .status-dot.idle{background: #9ca3af;}
    .room-card{background:var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow:var(--shadow); padding:1rem;}
    .btn-danger{border-radius:.6rem;}
    .btn-outline-secondary{border-radius:.6rem;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Rooms Monitoring</h1>

    <!-- simple pw form (same password as /reboot) -->
    {% if not authorized %}
      <form method="post" class="room-card" style="max-width:420px;">
        <label class="form-label">Password</label>
        <input type="password" class="form-control mb-3" name="pw" autofocus>
        <button class="btn btn-primary">Enter</button>
      </form>
    {% else %}
      <div class="room-card">
        <form method="post" action="{{ url_for('monitoring_logout') }}" class="ms-auto">
          <button class="btn btn-outline-secondary btn-sm">Sign out</button>
        </form>
        <div class="toolbar">
          <div class="btn-group" role="group" aria-label="Filter">
            <input type="radio" class="btn-check" name="flt" id="flt-all" value="all" checked>
            <label class="btn btn-outline-secondary" for="flt-all">All</label>

            <input type="radio" class="btn-check" name="flt" id="flt-active" value="active">
            <label class="btn btn-outline-secondary" for="flt-active">Active</label>

            <input type="radio" class="btn-check" name="flt" id="flt-processing" value="processing">
            <label class="btn btn-outline-secondary" for="flt-processing">Processing</label>
          </div>
          <span class="text-muted">Active = has songs or a current/processing job.</span>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th style="width:5%">Room</th>
                <th style="width:5%">Type</th>
                <th style="width:12%">Created At</th>
                <th style="width:8%">Songs</th>
                <th style="width:15%">Current</th>
                <th style="width:8%">Job Status</th>
                <th style="width:15%">Actions</th>
              </tr>
            </thead>
            <tbody id="roomsBody"></tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>

  {% if authorized %}
  <script>
  (() => {
    const socket = io();
    const body   = document.getElementById('roomsBody');
    let rooms = [];      // current dataset
    let joined = new Set(); // rooms we've joined to get live updates
    let filter = 'all';

    // filter controls
    document.querySelectorAll('input[name="flt"]').forEach(r => {
      r.addEventListener('change', () => { filter = r.value; render(); });
    });

    function isActive(r){
      return r.num_songs > 0 || r.in_process || (r.current_title && r.current_title.length);
    }

    function applyFilter(list){
      if(filter === 'processing') return list.filter(r => r.in_process);
      if(filter === 'active')     return list.filter(r => isActive(r));
      return list;
    }

    function fetchRooms(){
      fetch('/api/rooms').then(r => r.json()).then(data => {
        rooms = data;
        ensureJoins(rooms.map(r => r.room_id));
        render();
      });
    }

    function formatDate(epochSec){
      // local time, e.g. “2025-08-17 14:32”
      const d = new Date(epochSec * 1000);
      return d.toLocaleString([], { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    function ensureJoins(ids){
      // join every room so we get its playlist/player updates
      ids.forEach(id => {
        if(!joined.has(id)){
          socket.emit('join_room', { room_id: id });
          joined.add(id);
        }
      });
      // drop leaves (optional, harmless to keep joined)
    }

    function render(){
      const rows = applyFilter(rooms).map(r => {
        const modeLabel = r.mode === 'single' ? 'Single' : 'Multi';
        const dot = `<span class="status-dot ${r.in_process?'proc':'idle'}"></span>`;
        const statusText = r.in_process ? 'Processing' : (r.num_songs>0 ? 'Idle' : 'Empty');
        const current = r.current_title ? escapeHtml(r.current_title) : '<span class="text-muted">—</span>';
        const created = r.created_at ? formatDate(r.created_at) : '<span class="text-muted">—</span>';
        return `<tr data-room="${r.room_id}">
          <td><code>${r.room_id}</code></td>
          <td><span class="badge-mode">${modeLabel}</span></td>
          <td>${created}</td>
          <td>${r.num_songs} <span class="text-muted">(+${r.num_previous} prev)</span></td>
          <td>${current}</td>
          <td>${dot} <span class="ms-1">${statusText}</span></td>
          <td>
            <a class="btn btn-sm btn-outline-secondary me-2" target="_blank" href="${r.playlist_url}">Open Playlist</a>
            <button class="btn btn-sm btn-danger" data-remove="${r.room_id}">Remove</button>
          </td>
        </tr>`;
      }).join('');
      body.innerHTML = rows || `<tr><td colspan="7" class="text-center text-muted">No rooms</td></tr>`;
    }

    // remove room
    document.addEventListener('click', (e) => {
      const id = e.target?.dataset?.remove;
      if(!id) return;
      if(!confirm(`Remove room "${id}"?`)) return;
      const form = new FormData(); form.append('room_id', id);
      fetch('/api/remove_room', { method:'POST', body: form })
        .then(r => r.json())
        .then(() => fetchRooms())
        .catch(() => alert('Failed to remove room'));
    });

    // live refresh triggers
    socket.on('connect', fetchRooms);

    // when rooms are added/removed
    socket.on('rooms_list_updated', (_list /* array of ids */) => {
      // just re-pull the full details
      fetchRooms();
    });

    // whenever any room updates its playlist or player, refresh once
    socket.on('playlist_updated', () => fetchRooms());
    socket.on('player_updated',   () => fetchRooms());

    // utils
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  })();
  </script>
  {% endif %}
</body>
</html>
