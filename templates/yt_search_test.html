<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YouTube search demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
  body{padding:1rem;background:#f8f9fa;font-family:Arial,Helvetica,sans-serif}
  .thumb{width:100%;border-radius:6px;transition:transform .15s}
  .card:hover .thumb{transform:scale(1.05)}
  .card:hover{box-shadow:0 0 12px rgba(0,0,0,.2);cursor:pointer;transform:translateY(-2px);transition:.15s}
  .card:active{transform:scale(.98)}
  .prog-wrap{max-width:420px;margin:2rem auto}
</style>
</head>
<body>
<div class="container" style="max-width:800px">

  <h1 class="text-center mb-4">YouTube quick-test</h1>

  <!-- ---------- SEARCH BOX ---------- -->
  {% if not processing and not video_path %}
  <form class="input-group mb-4" method="get" action="/yt-search-test">
    <input type="text" name="search" class="form-control" placeholder="Search songs…"
           value="{{ query or '' }}" required>
    <button class="btn btn-primary" type="submit">Search</button>
  </form>
  {% endif %}

  <!-- ---------- RESULTS LIST ---------- -->
  {% if previews %}
    <h4 class="mb-3 text-secondary">Top results for “{{ query }}”</h4>
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for v in previews %}
        <div class="col">
          <form method="get" action="/yt-search-test" class="card h-100">
            <input type="hidden" name="video" value="{{ v.url }}">
            <img class="thumb card-img-top" src="{{ v.thumb }}" alt="">
            <div class="card-body p-2">
              <h6 class="card-title mb-1" style="font-size:.88rem">{{ v.title }}</h6>
              <p class="mb-0" style="font-size:.75rem;color:#555">
                {{ v.channel }}
              </p>
              <p class="mb-0" style="font-size:.75rem;color:#777">
                {{ v.views }} views&nbsp;•&nbsp;{{ v.uploaded }}<br>
                <strong>{{ v.duration }}</strong>
              </p>
            </div>
            <!-- invisible submit trigger -->
            <button class="stretched-link btn p-0" style="opacity:0"></button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ---------- PROGRESS ---------- -->
  {% if processing %}
    <div class="prog-wrap">
      <h4 class="text-center mb-3">{{ chosen_title }}</h4>
      <div class="progress">
        <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated"
             role="progressbar" style="width:0%">0%</div>
      </div>
      <p id="statTxt" class="text-center mt-2 text-muted">Starting…</p>
    </div>
  {% endif %}

  <!-- ---------- DOWNLOADED VIDEO ---------- -->
  {% if video_path %}
    <hr class="my-4">
    <h4 class="text-center mb-3">{{ chosen_title }}</h4>
    <video controls style="width:100%;max-height:70vh" src="/{{ video_path }}"></video>
  {% endif %}
</div>

{% if processing %}
<script>
const tid="{{ tid }}";
function poll(){
  fetch("/yt-status/"+tid).then(r=>r.json()).then(j=>{
     if(j.status==="done"){
        location.search="video="+encodeURIComponent(j.out_path);
        return;
     }
     const pct=Math.round((j.progress||0)*100);
     document.getElementById("bar").style.width=pct+"%";
     document.getElementById("bar").textContent=pct+"%";
     document.getElementById("statTxt").textContent=j.status==="error"?
       "Error – check logs": ("Processing… "+pct+"%");
     if(j.status!=="error") setTimeout(poll,1500);
  });
}
poll();
</script>
{% endif %}
</body>
</html>
